$(function(){var e={os:air.Capabilities.os.indexOf("win"),watching:[],defaultBg:!1,activityLen:0,loggedIn:!1,settings:{startAtLogin:!0,toured:null,username:null,loginName:null,apiToken:null,basicToken:null,lastUpdate:null,lastDbUpdate:null,activity:[]}},t={version:"0.0.7"},i={noteOpen:0,processDetection:null},n=$("#bottom"),a=$("#loading"),o=$("#activity-list"),s=$("#settings-ovl"),r=$("#middle"),c=null,l={note:{window:null,$body:null,open:!1},showSettings:function(){s.fadeIn(150)},hideSettings:function(){s.fadeOut(150)},glowRed:function(){window.nativeWindow.notifyUser(air.NotificationType.CRITICAL)},glowYellow:function(){window.nativeWindow.notifyUser(air.NotificationType.INFORMATIONAL)},centerWindow:function(){window.nativeWindow.x=(air.Capabilities.screenResolutionX-window.nativeWindow.width)/2,window.nativeWindow.y=(air.Capabilities.screenResolutionY-window.nativeWindow.height)/2},loading:function(e){a.addClass("visible").text(e+"...")},doneLoading:function(){a.removeClass("visible")},message:function(e){$("#top-user").text(e)},initNote:function(){if(!i.noteOpen){var e={note:new air.NativeWindowInitOptions,screenInfo:air.Screen.mainScreen.visibleBounds,noteBounds:new air.Rectangle(air.Screen.mainScreen.visibleBounds.width-312-30,air.Screen.mainScreen.visibleBounds.height-120-30,312,120)};e.note.resizable=!1,e.note.transparent=!0,e.note.maximizable=!1,e.note.type=air.NativeWindowType.LIGHTWEIGHT,e.note.systemChrome=air.NativeWindowSystemChrome.NONE,e.noteLoader=air.HTMLLoader.createRootWindow(!0,e.note,!1,e.noteBounds),e.noteLoader.paintsDefaultBackground=!1,e.noteLoader.stage.nativeWindow.alwaysInFront=!0,e.noteLoader.navigateInSystemBrowser=!0,i.openNotes=!0,e.noteLoader.load(new air.URLRequest("note.html")),l.note.window=e.noteLoader.window,e=null}},showNote:function(e,t,i,n){if(i=i||"scrobble",!l.note.open){air.trace("New note opened!");var a=$(l.note.window.document.body),o=a.find("#message-bg"),s=a.find("#message-close");l.note.open=!0,o.addClass("visible "+i),a.find("#message-title").html(e),a.find("#message-desc").html(t),a.find("#message-icon").css("background-image","url(img/nicons/"+i+".jpg)");var r=setTimeout(function(){o.removeClass("visible "+i),o.off(),s.off(),l.note.open=!1},7e3);s.click(function(e){e.stopPropagation(),clearTimeout(r),o.removeClass("visible "+i),air.trace("Closed note by cross"),o.off(),s.off(),l.note.open=!1}),o.click(function(){o.off(),s.off(),o.hasClass("scrobble")?(clearTimeout(r),setTimeout(function(){o.removeClass("visible "+i),l.note.open=!1},1e3),air.trace("Closed note by click")):(clearTimeout(r),o.removeClass("visible "+i),l.note.open=!1,air.trace("Closed note by scrobble")),n&&(n(),air.trace("Run note callback"))}).mouseup(function(e){e.stopPropagation(),2===e.button&&o.hasClass("scrobble")&&(clearTimeout(r),o.removeClass("visible scrobble"),o.off(),s.off(),l.note.open=!1,air.trace("Closed note by right-click"))})}}},d={isNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},openInBrowser:function(e){var t=new air.URLRequest(e);air.navigateToURL(t)},activityObject:function(){var t={published:(new Date).getTime(),verb:null,actor:{displayName:e.settings.username,url:"http://hummingbird.me/users/"+e.settings.loginName+"library"},target:{},object:{}};return t},generateColor:function(e){for(var t=0,i=0;t<e.length;i=e.charCodeAt(t++)+((i<<5)-i));for(var t=0,n="#";3>t;n+=("00"+(i>>8*t++&255).toString(16)).slice(-2));return n},displayActivity:function(){var t=e.settings.activity,i={};if(0!==t.length||e.defaultBg){if(e.activityLen<t.length||(new Date).getTime()-c>1e4){e.defaultBg||(r.removeClass("new"),e.defaultBg=!0),c=(new Date).getTime(),e.activityLen=t.length,o.empty();for(var n=0;n<t.length;n++)i[t[n].object.id]?i[t[n].object.id].push(t[n]):i[t[n].object.id]=[t[n]];for(var a in i){i[a].sort(function(e,t){return e=new Date(e.published),t=new Date(t.published),e>t?-1:t>e?1:0});for(var n=0;n<i[a].length;n++){var s=i[a][n];if(0==n){var l='<div class="cf activity '+s.verb+'"><div class="activity-icon-wrap"><div class="activity-icon" style="background-image: url(http://images.weserv.nl/?w=40&q=95&url='+s.object.image.replace("https://","")+')"><div class="activity-icon-ovl"></div></div></div><div class="activity-right"><div class="activity-timeago">'+moment(s.published).fromNow()+'</div><span class="activity-actor">'+s.actor.displayName+"</span> "+s.verb+' <a href="'+s.object.url+'" target="_blank" class="activity-object">'+s.object.displayName+"</a> to "+s.target.displayName+".</div></div>";l=i[a].length>1?'<div class="activity-wrap" data-lastupdate="'+s.published+'">'+l+'<ul class="sub-activity-list" data-id="'+s.object.id+'"></ul></div>':'<div class="activity-wrap" data-lastupdate="'+s.published+'">'+l+"</div>",o.prepend(l)}else if(10>n){var l='<li class="sub-activity cf"><div class="sub-activity-icon"></div><div class="sub-activity-right"><div class="sub-activity-timeago">'+moment(s.published).fromNow()+'</div><span class="sub-activity-actor">'+s.actor.displayName+"</span> "+s.verb+' <span class="sub-activity-object">'+s.object.displayName+".</span></div></li>";$('.sub-activity-list[data-id="'+s.object.id+'"]').append(l)}}}$(".activity-wrap").tsort({attr:"data-lastupdate",order:"desc"})}}else r.hasClass("new")||r.addClass("new")},versionCompare:function(e,t){if(typeof e+typeof t!="stringstring")return!1;for(var i=e.split("."),n=t.split("."),a=0,o=Math.max(i.length,n.length);o>a;a++){if(i[a]&&!n[a]&&parseInt(i[a])>0||parseInt(i[a])>parseInt(n[a]))return 1;if(n[a]&&!i[a]&&parseInt(n[a])>0||parseInt(i[a])<parseInt(n[a]))return-1}return 0},checkUpdates:function(){l.loading("Checking for updates"),setTimeout(function(){$.ajax({type:"get",url:"https://cdn.rawgit.com/Desuvader/Hummingbird-Updater/master/version",success:function(e){if(air.trace("Retrieved version info"),1===d.versionCompare(e.version,t.version)){l.loading("Downloading new update");var i=new air.URLLoader,n=new air.FileStream,a=new air.NativeProcess,o=new air.NativeProcessStartupInfo;i.dataFormat=air.URLLoaderDataFormat.BINARY,i.load(new air.URLRequest(e.url)),i.addEventListener(air.Event.COMPLETE,function(e){var t=air.File.applicationStorageDirectory.resolvePath(updateFileName);air.trace(t),n.open(t,air.FileMode.WRITE),n.writeBytes(e.target.data),n.close(),i.close(),o.executable=t,a.start(o),air.NativeApplication.nativeApplication.exit()})}else l.doneLoading()},error:function(){l.doneLoading()}})},1500)}},u={init:function(){l.initNote(),air.NativeApplication.supportsStartAtLogin&&e.settings.startAtLogin,l.centerWindow(),u.getUserSettings(function(){u.authenticate(function(){e.loggedIn=!0,$("#login-form-wrap").remove(),$("#open-herro").attr("href","http://hummingbird.me/users/"+e.settings.username+"/library"),d.checkUpdates(),l.message("Hey, "+e.settings.username+"!"),u.initTour(),u.detectionInit(),d.displayActivity(),u.createTrayIcon()})})},authenticate:function(t){e.settings.username&&e.settings.apiToken?t():(air.trace("Requires authentication!"),$("#login-form-wrap").show(),$("#login-form-submit").on("click",function(){var i=$(this);if(!i.hasClass("disabled")){$(this).addClass("disabled");var n=$("#login-value-username").val(),a=$("#login-value-password").val();l.loading("Authenticating"),$.ajax({data:{username:n,password:a},type:"post",url:"http://hummingbird.me/api/v1/users/authenticate",success:function(o){air.trace("Authenticated"),air.trace(o),e.settings.username=n.substr(0,1).toUpperCase()+n.substr(1),e.settings.password=a,e.settings.apiToken=o,u.saveUserSettings(),setTimeout(function(){i.removeClass("disabled"),$("#login-form-submit").off(),l.doneLoading(),t()},1e3)},error:function(e){air.trace("Error auth: "+JSON.stringify(e)),setTimeout(function(){i.removeClass("disabled"),l.doneLoading(),confirm("Wrong Username/API Token, try again")},1e3)}})}}))},detectionInit:function(){var t=new air.NativeProcessStartupInfo,n=air.File.applicationDirectory.resolvePath("detect.cmd"),a=null;t.executable=n,a=new air.NativeProcess,a.start(t),a.addEventListener(air.ProgressEvent.STANDARD_OUTPUT_DATA,function(){var t=a.standardOutput.readUTFBytes(a.standardOutput.bytesAvailable).replace(/\s+$/,""),i=[];i=t.split("\r\n");for(var n=0;n<i.length;n++){var o=i[n].replace(/^.*: /,"").replace(/ - ([^-]+) VLC.*/,"").replace(/ - VLC.*/,"").replace(/\r\n/,"").replace(/^\s+/,""),s=[];-1===e.watching.indexOf(o)&&o.match(/(.mkv$|.avi$|.mp4$)/)?(air.trace("New episode detected!"),s.push(o),u.scrobble(o)):e.watching.indexOf(o)>-1&&s.push(o)}e.watching=s}),i.processDetection=a},scrobble:function(t){var i={_id:null,slug:null,title:null,image:null,progress:null,score:null,filename:t},n=null,a=i.filename.replace(/\[.*?\]|(.mkv|.avi|.mp4)|\(.*\)/gi,"").replace(/_/g," ").replace(/^\s+|\s+$/g,""),n=i.filename.replace(/_/g," ").match(/[\._ \-]([0-9]{2,3})[v\._ \-\[\(].*[\[\(][0-9A-Za-z]{4,8}[\)\]][\/\._ \-\[\(]/);$.ajax({url:"http://hummingbird.me/api/v1/search/anime?query="+a,success:function(t){var o=[],s=t;if(air.trace('animeTitle: "'+a+'"'),air.trace("detectedEpisodes: "+n),n){for(var r=0;r<n.length;r++)d.isNumber(n[r])&&(i.progress=parseInt(parseFloat(n[r])),air.trace("Decided on episode "+i.progress));for(var r=0,c=s.length;c>r;r++)if(s[r].title){var p=a.distance(s[r].title);p>.7&&o.push({anime:s[r],score:p,title:s[r].title})}if(distanceResults=o.sort(function(e,t){var i=e.score,n=t.score;return i>n?-1:n>i?1:0}).slice(0,3),distanceResults.length){if(i._id=distanceResults[0].anime.id,i.title=distanceResults[0].title,i.slug=distanceResults[0].anime.id,i.image=distanceResults[0].anime.cover_image,i.score=distanceResults[0].score,i.progress){var v=i,g=d.activityObject();l.showNote("Do you want to update?",'Detected <span class="openbold">'+v.title+" Episode "+v.progress+"</span>","scrobble",function(){air.trace(JSON.stringify(v)),g.verb="scrobbled",g.object.id=v._id,g.object.title=v.title,g.object.progress=v.progress,g.object.displayName=v.title+" Episode "+v.progress,g.object.url="http://hummingbird.me/anime/"+v.slug,g.object.image=v.image,g.target.displayName="their list",e.settings.activity.push(g),u.saveUserSettings(),air.trace("Scrobbling..."),u.scrobbleAnime(v),v=null})}}else air.trace("Nothing matched distance search")}o=null,n=null,i=null,t=null,s=null}})},scrobbleAnime:function(t){$.ajax({type:"post",url:"http://hummingbird.me/api/v1/libraries/"+t._id,data:{id:t._id,auth_token:e.settings.apiToken,episodes_watched:t.progress},success:function(){air.trace("Updated!")},error:function(){confirm("Something went wrong when updating your list. Try updating directly through Hummingbird instead!")}})},initTour:function(){if(e.settings.toured)n.addClass("toured");else{var t=$("#tour-wrap"),i=$("#tour-slide-wrap"),a=$(".tour-control-wrap"),o=0;t.show(),u.saveUserSettings(),$("#tour-text-skip").click(function(){e.settings.toured=!0,t.addClass("hidden"),setTimeout(function(){t.hide(),n.addClass("toured")},550)}),$("#tour-take").click(function(){o=1,i.css("left","-=360px"),a.fadeIn(500),l.showNote("Do you want to update?","This is just an <b>example</b>. Keep reading the tour!")}),$(".tour-control-left").click(function(){i.position().left<0&&(o--,i.css("left","-"+360*o+"px"))}),$(".tour-control-right").click(function(){3>o?(o++,i.css("left","-"+360*o+"px")):3===o&&(o++,e.settings.toured=!0,u.saveUserSettings(),i.css("left","-"+360*o+"px"),a.fadeOut(500),setTimeout(function(){t.hide(),n.addClass("toured")},550))})}},replayTour:function(){e.settings.toured&&(e.settings.toured=!1,n.removeClass("toured"),$("#tour-wrap").removeClass("hidden"),$("#tour-slide-wrap").css("left","0"),u.initTour())},getUserSettings:function(t){var i=air.File(air.File.applicationStorageDirectory.resolvePath("settings.json")),n=function(){e.settings=$.parseJSON(i.data.readUTFBytes(i.data.bytesAvailable).toString()),i.removeEventListener(air.Event.COMPLETE,n),air.trace("Retrieved settings.json"),t&&t()};i.addEventListener(air.Event.COMPLETE,n),i.exists?i.load():u.saveUserSettings(function(){i.load()})},saveUserSettings:function(t){var i=new air.FileStream;i.open(air.File.applicationStorageDirectory.resolvePath("settings.json"),air.FileMode.WRITE),i.writeUTFBytes(JSON.stringify(e.settings)),i.close(),air.trace("Settings.json has been updated"),t&&t()},createTrayIcon:function(){var e=function(e){air.NativeApplication.nativeApplication.icon.bitmaps=[e.target.content.bitmapData]},t=new air.Loader,n=new air.NativeMenu,a=n.addItem(new air.NativeMenuItem("Open Updater")),o=n.addItem(new air.NativeMenuItem("Exit"));a.addEventListener(air.Event.SELECT,function(){l.glowYellow(),window.nativeWindow.activate()}),o.addEventListener(air.Event.SELECT,function(){confirm("Are you sure you want to exit?")&&(air.NativeApplication.nativeApplication.icon.bitmaps=[],i.processDetection&&i.processDetection.exit(!0),u.saveUserSettings(function(){air.NativeApplication.nativeApplication.exit()}))}),air.NativeApplication.supportsSystemTrayIcon&&(t.contentLoaderInfo.addEventListener(air.Event.COMPLETE,e),t.load(new air.URLRequest("img/16x16.png")),air.NativeApplication.nativeApplication.icon.tooltip="Hummingbird Updater",air.NativeApplication.nativeApplication.icon.menu=n,air.NativeApplication.nativeApplication.icon.addEventListener(air.MouseEvent.CLICK,function(){l.glowYellow(),window.nativeWindow.activate(),window.nativeWindow.alwaysInFront=!0,window.nativeWindow.alwaysInFront=!1}))}};u.init(),window.nativeWindow.addEventListener(air.Event.CLOSING,function(t){t.preventDefault(),i.processDetection&&i.processDetection.exit(!0),"mac"!==e.os?u.saveUserSettings(function(){air.NativeApplication.nativeApplication.exit()}):air.NativeApplication.nativeApplication.exit()}),setInterval(function(){e.loggedIn&&d.displayActivity()},2e3),$("#settings-clearrecent").click(function(){confirm("Are you sure you want to clear your recent activity?")&&(l.hideSettings(),e.settings.activity=[],o.empty(),e.defaultBg=!1,d.displayActivity(),u.saveUserSettings())}),$("#settings-retaketour").click(function(){l.hideSettings(),u.replayTour()}),$("#settings-clearall").click(function(){confirm("Are you sure you want to clear everything?")&&(air.trace("Resetting.."),air.File.applicationStorageDirectory.resolvePath("settings.json").deleteFile(),i.processDetection&&i.processDetection.exit(!0),location.reload())}),$("#settings-close").click(function(){l.hideSettings()}),$("#open-settings").click(function(){l.showSettings()}),$("#top").mousedown(function(){window.nativeWindow.startMove()}),$("#top-close").click(function(){e.loggedIn?(window.nativeWindow.visible=!1,l.showNote("Running in the background","You can still access the updater through the system tray","update")):(i.processDetection&&i.processDetection.exit(!0),u.saveUserSettings(function(){air.NativeApplication.nativeApplication.exit()}))}),$("#top-minimize").click(function(){window.nativeWindow.minimize(),air.System.gc()}),$("body").on("click",'a[target="_blank"]',function(e){e.preventDefault(),d.openInBrowser(this.href)})});